pico-8 cartridge // http://www.pico-8.com
version 42
__lua__
function _init()
	#include .capstone.p8:2
	#include .enemy.p8
	cartdata("dc_capstone")
	player_init()
	spring_init()
	btn_init()
	botinit()
	box_init()
	menuitem(1,"save",function() save() end)
	menuitem(2,"load",function() lload() end)
	menuitem(3,"main menu",function() load("main-menu.p8") end)
	menuitem(4,"debug file on/off",function() debu() end)
	menuitem(5,"reset save data",function() r_save() end)
	if dget(12)>0 and dget(12)<2 then
		dset(12,2)
	end
	if dget(13,true) then
		lload()
		dset(13,false)
	end
end

function _update()
	player_update()
	box_update()	
	btn_update(butts,player)
	spring_update(player)
	cam_update()
	player_animate()
end

function _draw()
	cls()
	map(0,0)
	btn_draw(butts)
	spring_draw()
	box_draw()
	spr(player.sp,player.x,player.y,1,1,player.flp)
end
-->8
function btn_init()
	butts={
	{x=216,y=104,sp=19,act="tp",p=false},
	{x=72,y=104,sp=19,act="nil",p=false},
	{x=136,y=104,sp=19,act="door",p=false}}
end

function btn_update(btns,obj)
	--updates the button sprites
	--if the player stands on them
	
	for b in all(btns) do
		if obj.x-8<=b.x and b.x<=obj.x+4 and obj.y-8<=b.y and b.y<=obj.y+2 and not b.p then
			b.sp+=1
			b.p=true
		end
	end
end

function btn_draw(btns)
	for b in all(btns) do
		spr(b.sp,b.x,b.y)
	end
end

function spring_init()
	spring_locs={{x=104,y=104,sp=51,start=0}}
end

function spring_update(obj)
	for s in all(spring_locs) do
		if obj.x>=s.x-6 and obj.x<s.x+6 and s.start==0 and flr(obj.y)<=s.y and flr(obj.y)>s.y-2  then
			s.sp+=1
			s.start=time()
		end
		if not (flr(obj.y)<=s.y and flr(obj.y)>s.y-2 and flr(obj.x)>=s.x-6 and flr(obj.x)<s.x+6) and s.sp==52 then
			s.start=0
			s.sp-=1
		end
		if time()-s.start>=0.5 and s.start != 0 then
			obj.dy-=(obj.boost*1.6)
			s.start=0
			s.sp-=1
		end
	end
end

function spring_draw()
	for s in all(spring_locs) do
		spr(s.sp,s.x,s.y)
	end
end

function box_init()
	box={{x=220,y=72,dx=0,dy=0,w=8,h=8,sp=4,g=0.3,f=0.8,acc=0.5,mx_dy=3,mx_dx=3.00,boost=4}}
end

function box_update()
	for b in all(box) do
		b.dy+=b.g
		b.dx*=b.f

		if b.dy>0 then
			b.dy=mid(-b.mx_dy,b.dy,b.mx_dy)
			if collide_map(b,"down",0) then
				b.dy=0
				b.y-=((b.y+b.h+1)%8)-1
			end--if
		elseif b.dy<0 then
			if collide_map(b,"up",0) then
				b.dy=0
			end
		end--if
		--this checks if the player is standing on top of the box or not
		if player.dy>0 and b.dy==0 then
			if player.y<b.y-4 and player.y>=b.y-8 and player.x>=b.x-6 and player.x<=b.x+6 then
				player.falling=false
				player.landed=true
				player.y=b.y-8
				player.dy=0
			end
		--[[
		first we check if the player is attempting to enter the box, if the player is inside of the box we "push" the box by 
		making it accelerate in the direction the player is going then we check collision and in those checks we stop the 
		player moving into the box if necessary
		]]
		elseif ((player.x>=b.x and player.x<b.x+8) or (player.x>=b.x-8 and player.x<b.x)) and ((player.y<=b.y and player.y>b.y-8)) then
			if player.dx<0 or player.x>=b.x+8 then
				b.dx-=b.acc
			elseif player.dx>0 or player.x+8<=b.x then
				b.dx+=b.acc
			end
		end
		if collide_map(b,"right",0) and b.dx>=0 then
			b.dx=0
			if player.dx>0 and player.x+8>b.x and player.x<b.x and player.y<=b.y and player.y>=b.y-7 then
				player.dx=0
				player.x=b.x-8
			end
		elseif collide_map(b,"left",0) and b.dx<=0 then
			b.dx=0
			if player.dx<0 and player.x<b.x+8 and player.x>b.x and player.y<=b.y and player.y>=b.y-7 then
				player.dx=0
				player.x=b.x+8
			end
		end
		
		b.dx=mid(-b.mx_dx,b.dx,b.mx_dx)
		b.dy=mid(-b.mx_dy,b.dy,b.mx_dy)

		b.x+=b.dx
		b.y+=b.dy
	end--for
	btn_update(butts,box[1])
end--function

function box_draw()
	for b in all(box) do
		spr(b.sp,b.x,b.y)
	end
end

__gfx__
0000000000000000bbbbbbbbbbbbbbbb999999990000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000003bbbb333333bbbbb9d4444690000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700000000003333333333333bbb94d446490000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0007700000dddd0099933399999a33bb944d64490000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000770000dddddd0a4493aaa6459a3339446d4490000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
007007000dcddcd0464464544444543394644d490000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000dddddd04445444445455443964444d90000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000dddd004544446446454463999999990000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000bbbbbbbb00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000bbbbb33300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000bbb3333308eeeee0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000dddd0bb33a999088888e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000ddcdcd333a954608888880000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00dddd000ddddddd33654444022228800288eee00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0dcddcd0ddddddd0344554545dd666665dd666660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00dddd0000dddd003644546455555dd655555dd60000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000055555555516226150000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00dddd00000dd0000000000051622615516226150000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0dcddcd0000dd0000000000051622615516226150000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0dddddd0000dd0000000000051622615516226150000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0dddddd000dddd000000000051622615516226150000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00dddd000dddddd00000000051622615516226150000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000dd0000dcddcd00000000051622615516226150000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000dd00000dddd000000000051622615516226150000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000dddd00000dd000dd005566000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000dcddcd000dddd000dddd665055000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000dddddd000dddd0005550000dd0055660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000dddddd00dddddd0dd0055660dddd6d50000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000ddd00dddddd00dddddd00dddd665dd0055660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000dcdcd00dddd000dddddd0055500000dddd6d50000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0ddddddd00dddd000dcddcd0dd000556dd5500660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
dddddddd000dd00000dddd000ddddd660dddd6600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0000010100000000000000000000000000000100000000000000000000000000000000010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
2400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000240000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000240000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000240000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000240000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000240000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000240000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000240000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000240000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000240000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000240000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000240000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2400000000000000000000000000000000000000000023120202020202020203000000000000000000000000000000000000000000000000240000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2400000000000000000000000000000023000000000024000000000000000000000000000000000000000000000000000000000000000000240000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2400000000000000000023000000000024000000000024000000000000000000000000000000000000000000000000000000000000000000240000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
